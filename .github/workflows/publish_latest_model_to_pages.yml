name: Publish latest model to GitHub Pages

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare docs folder
        run: mkdir -p docs

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Download release assets (from the published tag)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Release tag: $TAG"

          if [ -z "$TAG" ]; then
            echo "No release tag found (probably manual run). Downloading latest release assets..."
            gh release download --repo "${{ github.repository }}" --dir docs --pattern "policy_model.pth" --clobber
            gh release download --repo "${{ github.repository }}" --dir docs --pattern "move_vocab.pkl" --clobber
          else
            gh release download "$TAG" --repo "${{ github.repository }}" --dir docs --pattern "policy_model.pth" --clobber
            gh release download "$TAG" --repo "${{ github.repository }}" --dir docs --pattern "move_vocab.pkl" --clobber
          fi

      - name: Compute SHA256 and create version.json
        run: |
          POLICY_SHA=$(sha256sum docs/policy_model.pth | awk '{print $1}')
          VOCAB_SHA=$(sha256sum docs/move_vocab.pkl | awk '{print $1}')
          VERSION=$(date +%s)
          UPDATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > docs/version.json <<EOF
          {
            "version": ${VERSION},
            "updated_at": "${UPDATED_AT}",
            "files": {
              "policy_model.pth": { "sha256": "${POLICY_SHA}" },
              "move_vocab.pkl": { "sha256": "${VOCAB_SHA}" }
            }
          }
          EOF

          echo "----- version.json -----"
          cat docs/version.json

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
